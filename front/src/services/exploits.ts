import { grpcAddress } from "@/config.ts";
import { ServiceClient, ServiceDefinition } from "@/proto/exploits/api.ts";
import { useAuthContext } from "@/routes/authContext";
import {
  WebsocketTransport,
  createChannel,
  createClient,
  createClientFactory,
} from "nice-grpc-web";
import { useMemo } from "react";

const channel = createChannel(grpcAddress, WebsocketTransport());

export type ExploitServiceClient = ServiceClient;

export const rawExploitServiceClient: ExploitServiceClient = createClient(
  ServiceDefinition,
  channel
);

export function useExploitServiceClient(): ExploitServiceClient {
  const authContext = useAuthContext();
  return useMemo(
    () =>
      createClientFactory()
        .use((call, options) =>
          call.next(call.request, {
            ...options,
            metadata: {
              ...options.metadata,
              ...authContext.metadata,
            },
          })
        )
        .create(ServiceDefinition, channel),
    [authContext]
  );
}
